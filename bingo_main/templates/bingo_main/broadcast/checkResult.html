{% load static %}
{% load i18n %}
{% get_current_language as lang %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyBingo</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/polybingo-logotype-new.png' %}" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'broadcast/css/global.css' %}">
    <link rel="stylesheet" href="{% static 'broadcast/css/cardCheck.css' %}">
    <link rel="stylesheet" href="{% static 'broadcast/css/broadcastIndex.css' %}">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src="{% static 'js/dropzone.js' %}"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
</head>

<body {% if lang == 'he' %} dir='rtl' align='right' {% else %} style="text-align: left;" {% endif %}>

    <div id="landscapeOnly">
        <span>
            {% trans 'Please rotate your device to continue' %}
        </span>
    </div>
    <div class="alignCenter">
        
        {% include "bingo_main/partials/_prizes_sidebar.html" %}

        <div id="positionWrapping">
            <div class="innerContainer" id="enterPin">
                <div class="topArea">
                    <div id="topContainer">
                        {% if check_result == 'WIN' %}
                        {% trans 'Congratulations' %}
                        <br>
                        <span>{% trans 'Card Number' %} {{ board_number }} {% trans 'WON' %} 
                            {% if prize_1 %} {{ current_game.prize_1_name }} {% elif prize_2 %} {{ current_game.prize_2_name }} 
                            {% elif prize_3 %} {{ current_game.prize_3_name }} {% endif %}</span>
                        {% else %}
                        <span>{% trans 'Card Number' %} {{ board_number }}: {% trans 'Not yet' %}</span>
                        {% endif %}
                        <br>
                    </div>
                </div>
                <div class="bottomButtons">
                    <a class="button Check" style="font-family: inherit;"
                        href="{% url 'bingo_main:check_board' game_id=current_game.game_id %}">{% trans 'Check another' %}</a>
                    <a class="button green" style="font-family: inherit;"
                        href="{% url 'bingo_main:game' game_id=current_game.game_id %}">{% trans 'Continue' %}</a>
                </div>
            </div>

        </div>
    </div>
    <!-- <div class="buttonContainer">
        <div class="castButton">
            <google-cast-launcher id="share" --connected-color="white"></google-cast-launcher>
        </div>
    </div> -->

    <!-- <img src="{% static 'images/backgroundCheck.png' %}" class="speakerImage" alt=""> -->
    
    <script src="{% static 'broadcast/js/broadcastFunctions.js' %}"></script>
    
    
    <script>
        resize();

        window.addEventListener('resize', function (e) {
            resize();
        });


        /*
        window['__onGCastApiAvailable'] = function (isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        initializeCastApi = function () {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID
            });
            if (!cast) {
                document.querySelector('.castButton').style.display = 'none';
            }

            document.querySelector('#share').style.display = "block";
        };
        */

        function next(el, value) {
            if (isNaN(el.value)) return el.value = "";
        }

        function toggleList() {
            let el = document.querySelector('#userList');

            if (el.style.display == 'grid') {
                el.style.display = 'none';
            } else {
                el.style.display = 'grid';
            }
        }

        function resize() {
            // Reset
            document.querySelector('#prizeContainer').style = '';
            document.querySelector('#winCondition').style = '';
            document.querySelector('.innerContainer').style = '';
            //document.querySelector('.speaker').style = '';

            document.querySelector('body').style.height = window.innerHeight + 'px';

            // Resize bingo box to be the same height as the image
            const prizeSectionHeight = document.querySelector('#prize').clientHeight;
            prizeContainers = document.querySelectorAll('#prizeContainer');
            
            for (let index = 0; index != prizeContainers.length; index++) {
                prizeContainers[index].style.maxHeight = prizeSectionHeight / 3 + 'px';
            }


            document.querySelector('#winCondition').style.maxHeight = document.querySelector('.innerContainer').clientHeight + 'px';
            document.querySelector('#landscapeOnly').style.height = window.innerHeight + 'px';
        }

        function getData() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            let winCondition = urlParams.get('winCondition') ? urlParams.get('winCondition') : '2line';
            let content_bingo = "";
            let content_1line = "";
            let content_2line = "";
            
                for (let index = 0; index != 9; index++) {
                    content_bingo +=
                        '<div class="field"><div class="circle"></div></div>';
                }

                document.querySelectorAll('#bingoTable_bingo').forEach(el => {
                    el.innerHTML = content_bingo;
                });


                for (let index = 0; index != 3; index++) {
                    content_1line +=
                        '<div class="field"><div class="circle"></div></div>';
                }
                for (let index = 0; index != 6; index++) {
                    content_1line +=
                        '<div class="field"></div>';
                }

                document.querySelectorAll('#bingoTable_1line').forEach(el => {
                    el.innerHTML = content_1line;
                });

                for (let index = 0; index != 6; index++) {
                    content_2line +=
                        '<div class="field"><div class="circle"></div></div>';
                }
                for (let index = 0; index != 3; index++) {
                    content_2line +=
                        '<div class="field"></div>';
                }

                document.querySelectorAll('#bingoTable_2line').forEach(el => {
                    el.innerHTML = content_2line;
                });


            /*
            document.querySelectorAll('.bingoTable').forEach(el => {
                el.innerHTML = content;
            });
            */
        }

        function checkCard() {
            board_number = document.getElementById('cardNumber').value;
            console.log(`card: ${board_number}`);
            $.ajax({
                url: "{% url 'bingo_main:check_board' game_id=current_game.game_id %}",
                data: {
                    'board_number': board_number,
                    'host': '{{ user }}',
                },
                success: function (response) {
                    console.log(`Result: ${response}`);
                    //$('#card_area').html(response);
                }
            })


            if (!board_number) {
                alert('Please enter a valid card pin number')
                return
            } else {
                {% for player in winning_players %}
                console.log(`Winning player: {{ player }}`);
                {% endfor %}

                {% for board in winning_boards %}
                console.log(`Winning board: {{ board }}`);
                {% endfor %}

                /*
                $.ajax({
                    url: "{ url 'bingo_main:current_displayed_picture' game_id=game.game_id }",
                    success: function(response) {
                        //console.log(`polling current picture: ${response}`);
                        //$('#currentImage').html(response);
                        document.getElementById('currentImage').src = response;
                    }
                })
                */
            }

            document.querySelector('#checkPin').style.top = 0;
            setTimeout(() => {
                document.querySelector('#enterPin').style.top = '-100vh';
            }, 100);
            getCard();
        }

        function checkPin() {
            document.querySelector('.speakerImage').src = "{% static 'images/backgroundCheck.png' %}";
            document.querySelector('.speaker').src = "{% static 'images/speakerCheck.png' %}";
            document.querySelector('#checkPin').style.top = '-100vh';
            document.querySelector('#enterPin').style.top = 0;
        }

        function getCard(ticketNumber, gameCode) {
            // Get game size from api
            let size;
            let markedSquares = [3, 8, 13, 16, 17, 18, 19, 20];
            if (!size) size = '25';

            // Testing only DELETE FOR LIVE
            let success = true;

            if (success) {
                document.querySelector('.speakerImage').src = "{% static 'images/backgroundSuccess.png' %}";
                document.querySelector('.speaker').src = "{% static 'images/speakerSuccess.png' %}";
                document.querySelector('#winResult').style.display = 'grid';
                document.querySelector('#noResult').style.display = 'none';
            } else {
                document.querySelector('#winResult').style.display = 'none';
                document.querySelector('#noResult').style.display = 'grid';
            }

            document.querySelector('#checkPin').style.height = window.innerHeight - document.querySelector(
                '.speakerImage').clientHeight + 'px';

            document.querySelector('#checkPin .bingoTable').style.maxHeight = document.querySelector('#checkPin')
                .clientHeight - 100 + 'px';

            switch (size) {
                case '16':
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateRows = 'repeat(4, 1fr)';
                    genTable(16, markedSquares);
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateColumns =
                        `repeat(4, ${document.querySelector('#checkPin .field').clientHeight}px)`
                    break;

                case '25':
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateRows = 'repeat(5, 1fr)';
                    genTable(25, markedSquares);
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateColumns =
                        `repeat(5, ${document.querySelector('#checkPin .field').clientHeight}px)`
                    break;

                default:
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateRows = 'repeat(3, 1fr)';
                    genTable(9, markedSquares);
                    document.querySelector('#checkPin .bingoTable').style.gridTemplateColumns =
                        `repeat(3, ${document.querySelector('#checkPin .field').clientHeight}px)`
                    break;
            }
        }

        function genTable(size, markedSquares) {
            let content = '';
            for (let x = 1; x != size + 1; x++) {
                if (markedSquares.includes(x)) {
                    content +=
                        '<div class="field"><div class="circle"></div></div>';
                } else {
                    content +=
                        '<div class="field"></div>';
                }
            }
            document.querySelector('#checkPin .bingoTable').innerHTML = content;
        }
    </script>
</body>

</html>